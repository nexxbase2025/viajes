
<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Danbury Wheel Chair Service ‚Äî Dispatch</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <style>
    :root{ --brand:#0ea5ff; --ink:#eaf2ff; --bg:#0b1220; --card:#10192e; --muted:#9db3cf; --ok:#22c55e; --warn:#fbbf24; --no:#ef4444; }
    *{box-sizing:border-box}
    html{scroll-behavior:smooth; max-width:100%; overflow-x:hidden;}
    body{margin:0;background:linear-gradient(180deg,#0b1220,#08101f);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;max-width:100%;overflow-x:hidden;}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid #1e2a44;background:#0b1220;position:sticky;top:0;z-index:10}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800;letter-spacing:.6px}
    .logo img{width:34px;height:34px;border-radius:7px}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:var(--card);border:1px solid #1e2a44;border-radius:18px;padding:16px 16px 12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    h2{margin:4px 0 12px 0;font-size:18px;letter-spacing:.3px}
    label{font-size:13px;color:var(--muted)}
    input,select,textarea{width:100%;background:#0c1530;border:1px solid #233355;color:var(--ink);padding:12px 12px;border-radius:12px;font-size:14px}
    textarea{min-height:92px;resize:vertical}
    .row{display:grid;grid-template-columns:repeat(12,1fr);gap:10px;margin-bottom:10px}
    .col-6{grid-column:span 6}.col-4{grid-column:span 4}.col-8{grid-column:span 8}
    .col-3{grid-column:span 3}.col-12{grid-column:span 12}.col-2{grid-column:span 2}
    .row > *, .grid > * {min-width:0;}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0a1330;border:1px solid #203154;border-radius:999px;padding:8px 12px;font-size:12px}
    .btn{display:inline-flex;align-items:center;justify-content:center;gap:8px;border:1px solid #2a3d66;background:linear-gradient(180deg,#0e1b38,#0d1a33);padding:10px 14px;border-radius:12px;color:var(--ink);text-decoration:none;cursor:pointer}
    .btn:hover{border-color:#32508e}
    .btn.primary{background:linear-gradient(180deg,#0ea5ff,#0075ff);color:#051027;border-color:transparent;font-weight:700}
    .btn.ghost{background:transparent}
    .actions{display:flex;flex-wrap:wrap;gap:10px}
    .muted{color:var(--muted)}
    .hr{height:1px;background:#1e2a44;margin:12px 0}
    .preview{white-space:pre-wrap;background:#0a1226;border:1px dashed #30456f;border-radius:12px;padding:12px;overflow-wrap:anywhere;word-break:break-word;max-width:100%;}
    .footer{font-size:12px;color:var(--muted);text-align:center;margin:18px 0}
    .linkish{color:var(--ink);opacity:.9}
    .kpis{display:grid;grid-template-columns:repeat(3,1fr);gap:10px}
    .kpi{background:#0c1630;border:1px solid #22345a;border-radius:12px;padding:10px;cursor:pointer}
    .kpi b{font-size:18px}
    .centered{display:flex;align-items:center;justify-content:center;min-height:55vh;flex-direction:column;gap:12px;text-align:center}
    .login-card input{max-width:340px;margin:0 auto;display:block}
    @media print{header,.no-print{display:none !important} body{background:#fff;color:#000} .card{border:none;box-shadow:none} .preview{background:#fff;border:1px solid #ccc} }
    dialog{background:#0c1530;border:1px solid #2a3d66;color:var(--ink);border-radius:14px;max-width:720px}
    a.link{color:#9ecbff}
  </style>
</head>
<body>
<header>
  <div class="logo" aria-label="Danbury Wheel Chair Service">
    <img src="./icons/icon-192.png" alt="DW"/>
    <div>
      <div style="font-size:15px;line-height:1">Danbury Wheel Chair Service</div>
      <div class="pill" id="rolePill">‚Äî</div>
    </div>
  </div>
  <div style="margin-left:auto;display:flex;align-items:center;gap:10px" class="no-print">
    <button id="btnInstall" class="btn" style="display:none" data-i18n="install">Install</button>
    <select id="langSel" class="btn" aria-label="Language">
      <option value="auto">üåê Auto</option><option value="es">ES</option><option value="en">EN</option>
    </select>
    <button id="btnSignOut" class="btn" style="display:none" data-i18n="signout">Sign out</button>
  </div>
</header>

<div class="wrap">
  <!-- Landing / Login -->
  <section id="sectionAuth" class="card centered login-card" style="display:none">
    <img src="./icons/icon-192.png" width="72" height="72" alt="DW"/>
    <h2 id="welcomeTitle" data-i18n="welcome">Welcome</h2>
    <div class="muted" id="welcomeSub" data-i18n="signin">Sign in to continue</div>
    <div class="row" style="max-width:380px;width:100%">
      <div class="col-12"><input id="email" placeholder="email" autocomplete="username"/></div>
      <div class="col-12"><input id="password" placeholder="password" type="password" autocomplete="current-password"/></div>
      <div class="col-12 actions"><button id="btnSignIn" class="btn primary" style="width:100%" data-i18n="signin">Sign in</button></div>
    </div>
    <div class="muted" style="margin-top:10px" id="companyFooter">¬© 2025 Danbury Wheel Chair Service ¬∑ On time, every time! ¬∑ (203) 748 3433 ¬∑ www.danburywheelchairservice.com</div>
  </section>

  <!-- Dispatcher UI -->
  <div id="dispatcherUI" style="display:none">
    <div class="grid">
      <section class="card" id="formCard">
        <h2 id="title_form" data-i18n="new_dispatch">New dispatch</h2>
        <div class="row">
          <div class="col-6">
            <label id="lbl_client" data-i18n="client">Client / Requester</label>
            <input id="clientName" />
          </div>
          <div class="col-6">
            <label id="lbl_client_phone" data-i18n="client_phone">Client phone/email</label>
            <input id="clientContact" />
          </div>
          <div class="col-8">
            <label id="lbl_pick" data-i18n="pick">Pickup (origin)</label>
            <input id="from" />
          </div>
          <div class="col-4">
            <label id="lbl_pick_time" data-i18n="pick_time">Date/Time</label>
            <input id="pickupAt" type="datetime-local"/>
          </div>
          <div class="col-12">
            <label id="lbl_drop" data-i18n="drop">Dropoff (destination)</label>
            <input id="to" />
          </div>
          <div class="col-6">
            <label id="lbl_passenger" data-i18n="passenger">Passenger</label>
            <input id="passenger" />
          </div>
          <div class="col-2">
            <label id="lbl_age" data-i18n="age">Age</label>
            <input id="age" type="number" min="0" max="120"/>
          </div>
          <div class="col-4">
            <label id="lbl_companions" data-i18n="companions">Companions</label>
            <input id="companions" type="number" min="0" value="0"/>
          </div>
          <div class="col-12">
            <label id="lbl_needs" data-i18n="needs">Needs / Accessibility</label>
            <div class="row">
              <div class="col-4"><label class="pill"><input type="checkbox" id="needWheel"/> <span data-i18n="need_wheel">Wheelchair</span></label></div>
              <div class="col-4"><label class="pill"><input type="checkbox" id="needBari"/> <span data-i18n="need_bari">Bariatric chair</span></label></div>
              <div class="col-4"><label class="pill"><input type="checkbox" id="needStret"/> <span data-i18n="need_stret">Stretcher</span></label></div>
              <div class="col-4"><label class="pill"><input type="checkbox" id="needOxy"/> <span data-i18n="need_oxy">Oxygen</span></label></div>
              <div class="col-8"><label class="pill"><input type="checkbox" id="needExtra"/> <span data-i18n="need_extra">Extra staff</span></label></div>
            </div>
          </div>
          <div class="col-4">
            <label id="lbl_floor" data-i18n="floor">Destination floor</label>
            <input id="floor" type="number" min="0" value="0"/>
          </div>
          <div class="col-4">
            <label id="lbl_no_elev" data-i18n="no_elev">No elevator?</label>
            <select id="noElev"><option value="no" data-i18n="no">No</option><option value="yes" data-i18n="yes">Yes</option></select>
          </div>
          <div class="col-4">
            <label id="lbl_steps" data-i18n="steps"># steps</label>
            <input id="steps" type="number" min="0" value="0"/>
          </div>
          <div class="col-4">
            <label id="lbl_price" data-i18n="price">Price (USD)</label>
            <input id="price" type="number" min="0" step="0.01"/>
          </div>
          <div class="col-8">
            <label id="lbl_notes" data-i18n="notes">Notes</label>
            <input id="notes" />
          </div>
          <div class="col-12">
            <label id="lbl_driver" data-i18n="driver">Driver / Vehicle</label>
            <select id="driverSel"></select>
            <div class="muted" id="driverInfo"></div>
          </div>
        </div>
        <div class="actions no-print">
          <button class="btn" id="btnPreview">üìÑ <span data-i18n="generate">Generate summary</span></button>
          <button class="btn primary" id="btnSendDriver">üì® <span data-i18n="send">Send to driver</span></button>
          <a class="btn" id="btnMap" target="_self"><span data-i18n="open_map">Open map</span></a>
          <button class="btn" id="btnClientData"><span data-i18n="client_data">Client data</span></button>
          <button class="btn ghost" id="btnPrint" data-i18n="print">Print</button>
          <button class="btn" id="btnBackup" data-i18n="backup">Set backup</button>
          
        </div>
        <div class="hr"></div>
        <div>
          <label class="muted" id="lbl_preview" data-i18n="preview">Message preview</label>
          <div id="preview" class="preview"></div>
        </div>
      </section>

      <aside class="card">
        <h2 id="title_fleet" data-i18n="drivers">Drivers</h2>
        <div id="fleetList"></div>
        <div class="hr"></div>
        <div class="kpis">
          <div class="kpi" id="kpiTodayCard"><div class="muted" id="kpi_today" data-i18n="jobs_today">Jobs today</div><b id="kpiToday">0</b></div>
          <div class="kpi" id="kpiPendingCard"><div class="muted" id="kpi_pending" data-i18n="scheduled">Scheduled</div><b id="kpiPending">0</b></div>
          <div class="kpi"><div class="muted" id="kpi_drivers" data-i18n="drivers">Drivers</div><b id="kpiDrivers">‚Äî</b></div>
        </div>
      </aside>
    </div>
  </div>

  <!-- Driver UI -->
  <div id="driverUI" style="display:none">
    <section class="card">
      <h2 id="drv_title" data-i18n="my_jobs">My jobs</h2>
      <div class="actions">
        <span class="pill">‚úÖ <b id="drv_done_lbl" data-i18n="trips_done">Trips done</b>: <span id="drv_done_count">0</span></span>
        <span class="pill">üóìÔ∏è <b id="drv_sched_lbl" data-i18n="trips_sched">Scheduled</b>: <span id="drv_sched_count">0</span></span>
      </div>
      <div class="hr"></div>
      <div class="row">
        <div class="col-12">
          <h3 data-i18n="today">Today</h3>
          <div id="drv_today" class="preview">(empty)</div>
        </div>
        <div class="col-12">
          <h3 data-i18n="upcoming">Upcoming</h3>
          <div id="drv_upcoming" class="preview">(empty)</div>
        </div>
      </div>
    </section>
  </div>

  <div class="footer no-print">¬© 2025 Danbury Wheel Chair Service ‚Ä¢ </div>
</div>

<!-- How to install -->
<dialog id="howTo">
  <form method="dialog" style="margin:0">
    <div style="padding:16px 16px 4px"><b data-i18n="howto_title">Install on iPhone/iPad</b></div>
    <div style="padding:0 16px 12px" class="muted" id="howto_body">1) Open in Safari ¬∑ 2) Tap <b>Share</b> ¬∑ 3) <b>Add to Home Screen</b> ¬∑ 4) Confirm.</div>
    <div style="display:flex;justify-content:flex-end;padding:0 12px 12px"><button class="btn" data-i18n="ok">OK</button></div>
  </form>
</dialog>

<!-- KPI list -->
<dialog id="listDlg">
  <form method="dialog" style="margin:0">
    <div style="padding:16px 16px 4px"><b id="listDlgTitle">Items</b></div>
    <div style="padding:0 16px 12px; max-height:50vh; overflow:auto">
      <div id="listDlgBody" class="preview"></div>
    </div>
    <div style="display:flex;justify-content:flex-end;padding:0 12px 12px"><button class="btn" data-i18n="close">Close</button></div>
  </form>
</dialog>

<!-- Client data -->
<dialog id="clientDlg">
  <form method="dialog" style="margin:0">
    <div style="padding:16px 16px 4px"><b data-i18n="client_data">Client data</b></div>
    <div style="padding:0 16px 12px">
      <div class="row">
        <div class="col-12"><input id="clientSendTo" placeholder="WhatsApp (+1...), SMS (+1...), or email"/></div>
        <div class="col-12 actions">
          <button class="btn" id="sendToWA" data-i18n="send_whatsapp">Send WhatsApp</button>
          <button class="btn" id="sendToSMS" data-i18n="send_sms">Send SMS</button>
          <button class="btn" id="sendToEmail" data-i18n="send_email">Send Email</button>
        </div>
      </div>
      <div id="clientPreview" class="preview"></div>
    </div>
    <div style="display:flex;justify-content:flex-end;padding:0 12px 12px"><button class="btn" data-i18n="close">Close</button></div>
  </form>
</dialog>

<!-- Backup -->
<dialog id="backupDlg">
  <form method="dialog" style="margin:0">
    <div style="padding:16px 16px 4px"><b data-i18n="backup">Set backup</b></div>
    <div style="padding:0 16px 12px">
      <p class="muted" data-i18n="backup_desc">Backups are stored on this device. You can export a JSON file anytime.</p>
      <label class="pill"><input type="checkbox" id="autoSave"/> <span data-i18n="backup_auto">Auto‚Äësave summaries</span></label>
      <div class="hr"></div>
      <div class="actions">
        <button class="btn" id="btnExport" data-i18n="export_json">Export JSON</button>
        <button class="btn" id="btnExportTXT">Export TXT</button>
        <button class="btn" id="btnClearLocal" data-i18n="clear_local">Clear local</button>
      </div>
      <div class="muted" id="localInfo"></div>
    </div>
    <div style="display:flex;justify-content:flex-end;padding:0 12px 12px"><button class="btn" data-i18n="close">Close</button></div>
  </form>
</dialog>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";
  import { getAnalytics } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-analytics.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBIBq4ZsRADoKRNoJZkNq-dLWirlSotIPc",
    authDomain: "tripfast-d359d.firebaseapp.com",
    projectId: "tripfast-d359d",
    storageBucket: "tripfast-d359d.firebasestorage.app",
    messagingSenderId: "559477235356",
    appId: "1:559477235356:web:a311792f680f5fd5995759",
    measurementId: "G-CSRR8VWYFZ"
  };

  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);
  try { getAnalytics(app); } catch(e) {}

  const DISPATCHERS = ["donbeltranmusic@gmail.com"];
  const DRIVERS = ["fmluisorlando@gmail.com"];

  const COMPANY = {
    name: "Danbury Wheel Chair Service",
    slogan: "On time, every time!",
    phone: "(203) 748 3433",
    web: "www.danburywheelchairservice.com"
  };

  // i18n
  const STR = {
    en:{install:"Install",signout:"Sign out",welcome:"Welcome",signin:"Sign in to continue",
        new_dispatch:"New dispatch",client:"Client / Requester",client_phone:"Client phone/email",
        pick:"Pickup (origin)",pick_time:"Date/Time",drop:"Dropoff (destination)",
        passenger:"Passenger",age:"Age",companions:"Companions",needs:"Needs / Accessibility",
        need_wheel:"Wheelchair",need_bari:"Bariatric chair",need_stret:"Stretcher",need_oxy:"Oxygen",need_extra:"Extra staff",
        floor:"Destination floor",no_elev:"No elevator?",steps:"# steps",price:"Price (USD)",notes:"Notes",
        driver:"Driver / Vehicle",generate:"Generate summary",send:"Send to driver",
        open_map:"Open map",client_data:"Client data",print:"Print",preview:"Message preview",
        drivers:"Drivers",jobs_today:"Jobs today",scheduled:"Scheduled",my_jobs:"My jobs",
        trips_done:"Trips done",trips_sched:"Scheduled",today:"Today",upcoming:"Upcoming",
        how_to_install:"How to install",howto_title:"Install on iPhone/iPad",
        howto_body:"1) Open in Safari ¬∑ 2) Tap <b>Share</b> ¬∑ 3) <b>Add to Home Screen</b> ¬∑ 4) Confirm.",
        ok:"OK",close:"Close",dispatcher:"Dispatcher",driver_role:"Driver",user:"User",
        alert_fill:"Complete origin and destination",alert_pick_driver:"Pick a driver",
        saved:"Saved and sent to driver.",login_error:"Login error: ",installed:"Installed",
        backup:"Set backup",backup_desc:"Backups are stored on this device. You can export a JSON file anytime.",backup_auto:"Auto‚Äësave summaries",
        export_json:"Export JSON",clear_local:"Clear local",
        send_whatsapp:"Send WhatsApp",send_sms:"Send SMS",send_email:"Send Email",empty:"(empty)",
        saved_local:"Saved locally.", saved_server_fail:"Could not save to server. Saved locally instead."
    },
    es:{install:"Instalar",signout:"Cerrar sesi√≥n",welcome:"Bienvenido",signin:"Inicia sesi√≥n para continuar",
        new_dispatch:"Nuevo despacho",client:"Cliente / Solicitante",client_phone:"Tel√©fono/correo del cliente",
        pick:"Recogida (origen)",pick_time:"Fecha/Hora",drop:"Destino (llegada)",
        passenger:"Pasajero",age:"Edad",companions:"Acompa√±antes",needs:"Necesidades / Accesibilidad",
        need_wheel:"Silla de ruedas",need_bari:"Silla bari√°trica",need_stret:"Camilla",need_oxy:"Ox√≠geno",need_extra:"Personal extra",
        floor:"Piso de destino",no_elev:"¬øSin ascensor?",steps:"# escalones",price:"Precio (USD)",notes:"Notas",
        driver:"Conductor / Veh√≠culo",generate:"Generar resumen",send:"Enviar al conductor",
        open_map:"Abrir mapa",client_data:"Datos del cliente",print:"Imprimir",preview:"Vista previa del mensaje",
        drivers:"Conductores",jobs_today:"Despachos hoy",scheduled:"Programados",my_jobs:"Mis viajes",
        trips_done:"Viajes realizados",trips_sched:"Programados",today:"Hoy",upcoming:"Pr√≥ximos",
        how_to_install:"C√≥mo instalar",howto_title:"Instalar en iPhone/iPad",
        howto_body:"1) Abre en Safari ¬∑ 2) Toca <b>Compartir</b> ¬∑ 3) <b>A√±adir a pantalla de inicio</b> ¬∑ 4) Confirmar.",
        ok:"OK",close:"Cerrar",dispatcher:"Despachador",driver_role:"Conductor",user:"Usuario",
        alert_fill:"Completa origen y destino",alert_pick_driver:"Selecciona un conductor",
        saved:"Despacho guardado y enviado al conductor.",login_error:"Error de inicio de sesi√≥n: ",installed:"Instalada",
        backup:"Configurar respaldo",backup_desc:"Los respaldos se guardan en este dispositivo. Puedes exportar un archivo JSON cuando quieras.",backup_auto:"Auto‚Äëguardar res√∫menes",
        export_json:"Exportar JSON",clear_local:"Borrar local",
        send_whatsapp:"Enviar WhatsApp",send_sms:"Enviar SMS",send_email:"Enviar Email",empty:"(vac√≠o)",
        saved_local:"Guardado localmente.", saved_server_fail:"No se pudo guardar en el servidor. Guardado localmente."
    }
  };
  function getLang(){ const forced=localStorage.getItem('tf_lang_forced'); if(forced && forced!=='auto') return forced; return (navigator.language||'es').toLowerCase().startsWith('es')?'es':'en'; }
  function t(k){ const lang=getLang(); return STR[lang][k]||STR.en[k]||k; }
  function applyI18n(){
    document.querySelectorAll('[data-i18n]').forEach(el=>{ const key=el.getAttribute('data-i18n'); el.innerHTML=t(key); });
    const placeholders=[["#email","email","correo"],["#password","password","contrase√±a"],["#clientName","Name and phone","Nombre y tel√©fono"],["#clientContact","+1 ‚Ä¶ or email","+1 ‚Ä¶ o correo"],["#from","Exact address‚Ä¶","Direcci√≥n exacta‚Ä¶"],["#to","Address or reference‚Ä¶","Direcci√≥n o referencia‚Ä¶"],["#passenger","First and last name","Nombre y apellido"],["#notes","Additional instructions‚Ä¶","Indicaciones adicionales‚Ä¶"],["#clientSendTo","WhatsApp (+1...), SMS (+1...), or email","WhatsApp (+1...), SMS (+1...) o correo"]];
    const es=getLang()==='es'; placeholders.forEach(([sel,en,esTxt])=>{ const el=document.querySelector(sel); if(el) el.setAttribute('placeholder', es?esTxt:en); });
    const pill=document.getElementById('rolePill'); if(pill.dataset.role){ const map={dispatcher:'dispatcher',driver:'driver_role',user:'user'}; pill.textContent=t(map[pill.dataset.role]||'user'); }
  }
  const sel=document.getElementById('langSel'); sel.value=localStorage.getItem('tf_lang_forced')||'auto'; sel.addEventListener('change',()=>{ localStorage.setItem('tf_lang_forced', sel.value); location.reload(); });
  const $=(s)=>document.querySelector(s);

  // Fleet
  const DEFAULT_DRIVERS=[{id:'YbrStIOyf7NGabgUvlkbOqiR7cq2',email:'fmluisorlando@gmail.com',name:'Luis Orlando',phone:'+1',vehicle:'Ford Transit',plate:'‚Äî',whatsapp:'+1'}];
  let fleet=[...DEFAULT_DRIVERS];
  async function loadDrivers(){ try{ const snap=await getDocs(collection(db,'drivers')); const list=[]; snap.forEach(d=>list.push(d.data())); if(list.length) fleet=list; }catch(e){} }
  function paintFleet(){
    $('#kpiDrivers').textContent=String(fleet.length);
    const sel=$('#driverSel'); sel.innerHTML=''; fleet.forEach(d=>{ const opt=document.createElement('option'); opt.value=d.id||d.uid||d.email; opt.textContent=`${d.name||d.email} ‚Ä¢ ${d.vehicle||''} ‚Ä¢ ${d.plate||''}`; sel.appendChild(opt); });
    const list=$('#fleetList'); list.innerHTML=fleet.map(d=>`<div class="pill" style="margin:4px 6px 6px 0;display:flex;justify-content:space-between;align-items:center;width:100%"><span>üöó <b>${d.name||d.email}</b> ¬∑ ${d.vehicle||'‚Äî'} ¬∑ ${d.plate||'‚Äî'} ¬∑ <span class="muted">${d.phone||''}</span></span></div>`).join('');
    updateDriverInfo();
  }
  function findDriver(id){ return fleet.find(d=>(d.id||d.uid||d.email)==id) || fleet[0]; }
  function updateDriverInfo(){ const d=findDriver($('#driverSel').value); if(!d) return; $('#driverInfo').textContent = `Phone: ${d.phone||'‚Äî'} ¬∑ WhatsApp: ${d.whatsapp||'‚Äî'} ¬∑ Email: ${d.email||'‚Äî'}`; }
  $('#driverSel')?.addEventListener('change', updateDriverInfo);

  // Helpers
  function accSummary(){ const items=[]; if($('#needWheel').checked) items.push(t('need_wheel')); if($('#needBari').checked) items.push(t('need_bari')); if($('#needStret').checked) items.push(t('need_stret')); if($('#needOxy').checked) items.push(t('need_oxy')); if($('#needExtra').checked) items.push(t('need_extra')); return items.length?items.join(', '):'N/A'; }
  function buildMapUrl(pickup,destination){ const enc=encodeURIComponent; const base="https://www.google.com/maps/dir/?api=1"; return `${base}&destination=${enc(destination)}&waypoints=${enc(pickup)}&travelmode=driving&dir_action=navigate`; }
  function companyFooter(){ return `\n\n‚Äî ${COMPANY.name} ‚Ä¢ ${COMPANY.slogan}\n‚òé ${COMPANY.phone} ‚Ä¢ ${COMPANY.web}`; }

  function collect(){
    const driver=findDriver($('#driverSel').value);
    const from=$('#from').value.trim(); const to=$('#to').value.trim();
    const mapUrl=(from&&to)?buildMapUrl(from,to):'';
    const pickupAt=$('#pickupAt').value? new Date($('#pickupAt').value).toISOString():null;
    return {clientName:$('#clientName').value.trim(), clientContact:$('#clientContact').value.trim(),
      passenger:$('#passenger').value.trim(), age:Number($('#age').value||0), companions:Number($('#companions').value||0),
      from,to,mapUrl,pickupAt, acc:accSummary(), floor:Number($('#floor').value||0), noElev:$('#noElev').value, steps:Number($('#steps').value||0),
      price:Number($('#price').value||0), notes:$('#notes').value.trim(), driver };
  }

  function renderPreview(){
    const o=collect();
    const when=o.pickupAt ? new Date(o.pickupAt).toLocaleString(getLang()==='es'?'es-ES':'en-US'):'-';
    const msg=`Client: ${o.clientName} (${o.clientContact})\nPassenger: ${o.passenger} ‚Ä¢ ${o.age? t('age')+': '+o.age:''} ‚Ä¢ ${t('companions')}: ${o.companions}\n${t('pick')}: ${o.from}\n${t('drop')}: ${o.to}\n${t('pick_time')}: ${when}\n${t('needs')}: ${o.acc}\nBuilding: ${t('floor')} ${o.floor} ‚Ä¢ ${o.noElev==='yes'?t('no_elev'):'Elevator'} ‚Ä¢ ${t('steps')}: ${o.steps}\n${t('price')}: ${o.price}\nNotes: ${o.notes||'-'}\nROUTE: ${o.mapUrl}` + companyFooter();
    $('#preview').textContent=msg;
    return {msg,data:o};
  }

  // Local storage
  function getLocalJobs(){ try{ return JSON.parse(localStorage.getItem('dwcs_jobs')||'[]'); }catch(e){ return []; } }
  function setLocalJobs(a){ localStorage.setItem('dwcs_jobs', JSON.stringify(a)); }
  function saveLocalJob(job){ const a=getLocalJobs(); const id=Date.now()+'_'+Math.random().toString(36).slice(2,8); a.push({...job,id,status:job.status||'draft', savedAt:new Date().toISOString()}); setLocalJobs(a); return id; }
  function updateLocalJob(id,patch){ const a=getLocalJobs(); const i=a.findIndex(x=>x.id===id); if(i>=0){ a[i]={...a[i],...patch}; setLocalJobs(a); } }
  function getLocalDriverInbox(driverKey){ try{ return JSON.parse(localStorage.getItem('dwcs_inbox_'+driverKey)||'[]'); }catch(e){ return []; } }
  function addToLocalDriverInbox(driverKey, job){ const a=getLocalDriverInbox(driverKey); a.push(job); localStorage.setItem('dwcs_inbox_'+driverKey, JSON.stringify(a)); }

  function refreshLocalInfo(){ const arr=getLocalJobs(); const todayStr=(new Date()).toDateString(); let today=0; let future=0; arr.forEach(j=>{ const when=j.pickupAt? new Date(j.pickupAt):null; if(!when) return; if(when.toDateString()===todayStr) today++; if(when>new Date()) future++; }); $('#localInfo').textContent = `${arr.length} local items ‚Ä¢ ${today} today`; }

  // KPIs from server + local
  async function refreshKPIs(){
    const itemsToday=[], itemsFuture=[]; const now=new Date(); const todayStr=now.toDateString();

    // Firestore
    try{
      const all=await getDocs(query(collection(db,'jobs')));
      all.forEach(d=>{ const j=d.data(); const when=j.pickupAt?.toDate? j.pickupAt.toDate() : (j.pickupAt? new Date(j.pickupAt):null); if(!when) return;
        const line=`${when.toLocaleString(getLang()==='es'?'es-ES':'en-US')} ‚Äî ${j.passenger} ¬∑ ${j.from} ‚Üí ${j.to} ¬∑ $${j.price||'-'}`;
        if(when.toDateString()===todayStr) itemsToday.push(line);
        if(when>now) itemsFuture.push(line);
      });
    }catch(e){ /* ignore */ }

    // Local
    getLocalJobs().forEach(j=>{ const when=j.pickupAt? new Date(j.pickupAt):null; if(!when) return;
      const line=`${when.toLocaleString(getLang()==='es'?'es-ES':'en-US')} ‚Äî ${j.passenger} ¬∑ ${j.from} ‚Üí ${j.to} ¬∑ $${j.price||'-'} (local)`;
      if(when.toDateString()===todayStr) itemsToday.push(line);
      if(when>now) itemsFuture.push(line);
    });

    $('#kpiToday').textContent=String(itemsToday.length);
    $('#kpiPending').textContent=String(itemsFuture.length);
    $('#kpiTodayCard').onclick=()=>openListDlg(t('jobs_today'), itemsToday);
    $('#kpiPendingCard').onclick=()=>openListDlg(t('scheduled'), itemsFuture);
  }

  function openListDlg(title, lines){ $('#listDlgTitle').textContent=title; $('#listDlgBody').textContent=lines.length?lines.join('\n'):t('empty'); $('#listDlg').showModal(); }
  function urlify(text){ const urlRegex=/(https?:\/\/[^\s]+)/g; return text.replace(urlRegex, (url)=>'<a class="link" href="'+url+'" target="_self">'+url+'</a>'); }

  // Driver view merge (server + local mirror)
  async function loadDriverJobs(user){
    const now=new Date(); const todayStr=now.toDateString(); const today=[], upcoming=[], done=[];

    const driverKey = user.uid || user.email;
    // Firestore
    try{
      const my=await getDocs(query(collection(db,'jobs'), where('driverRef','==', driverKey)));
      my.forEach(d=>{ const j=d.data(); const when=j.pickupAt?.toDate? j.pickupAt.toDate() : (j.pickupAt? new Date(j.pickupAt):null);
        const baseTxt = `# ${j.passenger} ‚Äî ${j.from} ‚Üí ${j.to}\n${t('pick_time')}: ${when?when.toLocaleString(getLang()==='es'?'es-ES':'en-US'):'-'}\n${t('price')}: ${j.price||'-'}\n${t('needs')}: ${j.needs||'N/A'}\nROUTE: ${j.mapUrl}` + companyFooter();
        const baseHtml=urlify(baseTxt).replaceAll('\n','<br/>');
        const card=`<div>${baseHtml}</div>`;
        if(when && when<now) done.push(card);
        if(when && when.toDateString()===todayStr) today.push(card);
        if(when && when>now) upcoming.push(card);
      });
    }catch(e){}

    // Local mirror inbox (same device testing)
    getLocalDriverInbox(driverKey).forEach(j=>{
      const when=j.pickupAt? new Date(j.pickupAt):null;
      const baseTxt = `# ${j.passenger} ‚Äî ${j.from} ‚Üí ${j.to}\n${t('pick_time')}: ${when?when.toLocaleString(getLang()==='es'?'es-ES':'en-US'):'-'}\n${t('price')}: ${j.price||'-'}\n${t('needs')}: ${j.acc||'N/A'}\nROUTE: ${j.mapUrl}` + companyFooter();
      const baseHtml=urlify(baseTxt).replaceAll('\n','<br/>');
      const card=`<div>${baseHtml}</div>`;
      if(when && when<now) done.push(card);
      if(when && when.toDateString()===todayStr) today.push(card);
      if(when && when>now) upcoming.push(card);
    });

    $('#drv_today').innerHTML=today.join('<br/><br/>')||t('empty');
    $('#drv_upcoming').innerHTML=upcoming.join('<br/><br/>')||t('empty');
    $('#drv_done_count').textContent=String(done.length);
    $('#drv_sched_count').textContent=String(upcoming.length);
  }

  // Auth / routing
  const sectionAuth=$('#sectionAuth'); const dispatcherUI=$('#dispatcherUI'); const driverUI=$('#driverUI'); const rolePill=$('#rolePill');
  const btnSignIn=$('#btnSignIn'); const btnSignOut=$('#btnSignOut');
  btnSignIn.addEventListener('click', async ()=>{ const email=$('#email').value.trim(); const password=$('#password').value; try{ await signInWithEmailAndPassword(auth,email,password); }catch(e){ alert(t('login_error')+e.message); } });
  btnSignOut.addEventListener('click', async ()=>{ await signOut(auth); });
  function showOnly(s){ sectionAuth.style.display='none'; dispatcherUI.style.display='none'; driverUI.style.display='none'; s.style.display='block'; }
  function landing(){ showOnly(sectionAuth); }

  onAuthStateChanged(auth, async (user)=>{
    if(!user){ rolePill.textContent='‚Äî'; rolePill.dataset.role=''; landing(); return; }
    $('#btnSignOut').style.display='inline-flex';
    await loadDrivers(); paintFleet();
    const email=user.email||'';
    if(DISPATCHERS.includes(email)){ rolePill.dataset.role='dispatcher'; rolePill.textContent=t('dispatcher'); showOnly(dispatcherUI); await refreshKPIs(); }
    else if(DRIVERS.includes(email)){ rolePill.dataset.role='driver'; rolePill.textContent=t('driver_role'); showOnly(driverUI); await loadDriverJobs(user); }
    else { rolePill.dataset.role='user'; rolePill.textContent=t('user'); landing(); alert('No role assigned for this account.'); }
    applyI18n();
  });

  // Buttons
  $('#btnPreview').addEventListener('click', ()=>{
    const {data}=renderPreview();
    if(!data.from || !data.to){ alert(t('alert_fill')); return; }
    const id=saveLocalJob({...data,status:'draft'});
    refreshLocalInfo(); refreshKPIs();
    alert(t('saved_local'));
  });

  $('#btnSendDriver').addEventListener('click', async ()=>{
    const {data}=renderPreview();
    if(!data.from || !data.to){ alert(t('alert_fill')); return; }
    if(!data.driver){ alert(t('alert_pick_driver')); return; }
    // Try server
    let serverOk=false;
    try{
      const job={createdAt:serverTimestamp(), pickupAt:data.pickupAt||null, from:data.from,to:data.to,mapUrl:data.mapUrl,
        passenger:data.passenger,age:data.age,companions:data.companions, needs:data.acc, floor:data.floor,noElev:data.noElev,steps:data.steps,
        price:data.price,notes:data.notes, clientName:data.clientName,clientContact:data.clientContact,
        driverRef:data.driver.id||data.driver.uid||data.driver.email, driverEmail:data.driver.email||null, status:'scheduled'};
      await addDoc(collection(db,'jobs'), job);
      serverOk=true;
    }catch(e){ /* swallow */ }
    // Always store/mark locally
    const id=saveLocalJob({...data,status:'sent'});
    // Mirror into local inbox for driver (same device testing)
    const driverKey=data.driver.id||data.driver.uid||data.driver.email;
    addToLocalDriverInbox(driverKey, {...data,status:'sent'});
    refreshLocalInfo(); refreshKPIs();
    alert(serverOk? t('saved') : t('saved_server_fail'));
  });

  $('#btnMap').addEventListener('click', ()=>{ const {data}=renderPreview(); if(!data.mapUrl) return alert(t('alert_fill')); $('#btnMap').href=data.mapUrl; });
  $('#btnPrint').addEventListener('click', ()=>window.print());

  // Client dialog
  $('#btnClientData').addEventListener('click', ()=>{ const {msg}=renderPreview(); $('#clientPreview').textContent=msg; $('#clientDlg').showModal(); });
  $('#sendToWA').addEventListener('click',(e)=>{ e.preventDefault(); const to=$('#clientSendTo').value.replace(/\D/g,''); const {msg}=renderPreview(); if(!to) return; window.open(`https://wa.me/${to}?text=${encodeURIComponent(msg)}`,'_blank'); });
  $('#sendToSMS').addEventListener('click',(e)=>{ e.preventDefault(); const to=$('#clientSendTo').value.replace(/\D/g,''); const {msg}=renderPreview(); if(!to) return; const body=encodeURIComponent(msg); const url = navigator.userAgent.match(/(iPhone|iPad)/) ? `sms:${to}&body=${body}` : `sms:${to}?body=${body}`; location.href=url; });
  $('#sendToEmail').addEventListener('click',(e)=>{ e.preventDefault(); const to=$('#clientSendTo').value.trim(); const {msg}=renderPreview(); if(!to) return; const subject=encodeURIComponent('Dispatch'); window.open(`mailto:${to}?subject=${subject}&body=${encodeURIComponent(msg)}`,'_blank'); });

  // Backup dialog
  $('#btnBackup').addEventListener('click', ()=>{ $('#backupDlg').showModal(); $('#autoSave').checked = localStorage.getItem('dwcs_auto_save')==='1'; refreshLocalInfo(); });
  $('#btnSaveNow').addEventListener('click', ()=>{ const {data}=renderPreview(); saveLocalJob({...data,status:'draft'}); refreshLocalInfo(); refreshKPIs(); alert(t('saved_local')); });
  $('#autoSave').addEventListener('change', (e)=>{ localStorage.setItem('dwcs_auto_save', e.target.checked ? '1':'0'); });
  $('#btnExport').addEventListener('click', (e)=>{ e.preventDefault(); const data = JSON.stringify(getLocalJobs(), null, 2); const blob=new Blob([data],{type:'application/json'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download='dwcs-backup.json'; document.body.appendChild(a); a.click(); a.remove(); setTimeout(()=>URL.revokeObjectURL(url), 1000); });
  $('#btnClearLocal').addEventListener('click', (e)=>{ e.preventDefault(); if(confirm('Clear local data?')){ localStorage.removeItem('dwcs_jobs'); refreshLocalInfo(); refreshKPIs(); } });

  // Registrar SW (se mantiene igual)
  if('serviceWorker' in navigator){ 
    window.addEventListener('load',()=>{ 
      navigator.serviceWorker.register('./sw.js?v=dwcs-v5'); 
    }); 
  }

  // --- Detectar idioma desde el inicio
  applyI18n();

  // --- PWA / Burbuja Install ---
  const btnInstall = document.getElementById("btnInstall");

  function isStandalone() {
    return (
      window.matchMedia("(display-mode: standalone)").matches ||
      window.navigator.standalone === true
    );
  }

  function isAndroid() {
    return /Android/i.test(navigator.userAgent);
  }

  function isIOS() {
    return /iPad|iPhone|iPod/.test(navigator.userAgent) && !window.MSStream;
  }

  function updateInstallButton() {
    if (isStandalone()) {
      btnInstall.style.display = "none";
      return;
    }
    if (isAndroid()) {
      btnInstall.style.display = "inline-flex";
      btnInstall.onclick = () => {
        if (window.deferredPrompt) {
          window.deferredPrompt.prompt();
          window.deferredPrompt.userChoice.then(({ outcome }) => {
            if (outcome === "accepted") {
              btnInstall.style.display = "none";
            }
            window.deferredPrompt = null;
          });
        } else {
          alert(
            getLang() === "es"
              ? "Para instalar, usa el men√∫ del navegador y selecciona 'A√±adir a pantalla principal'."
              : "To install, use the browser menu and select 'Add to Home screen'."
          );
        }
      };
      return;
    }
    if (isIOS()) {
      btnInstall.style.display = "inline-flex";
      btnInstall.onclick = () => {
        const dlg = document.getElementById("howTo");
        dlg.showModal();
      };
    }
  }

  window.addEventListener("beforeinstallprompt", (e) => {
    e.preventDefault();
    window.deferredPrompt = e;
    updateInstallButton();
  });

  window.addEventListener("appinstalled", () => {
    btnInstall.style.display = "none";
  });

  // Inicial
  updateInstallButton();
</script>
</body>
</html>