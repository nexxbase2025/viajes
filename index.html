<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="theme-color" content="#0b1220" />
  <title>Danbury Wheel Chair Service ‚Äî Dispatch</title>
  <link rel="manifest" href="./manifest.webmanifest" />
  <link rel="apple-touch-icon" href="./icons/icon-192.png" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  <style>
    :root{ --brand:#0ea5ff; --ink:#eaf2ff; --bg:#0b1220; --card:#10192e; --muted:#9db3cf; }
    body{margin:0;background:linear-gradient(180deg,#0b1220,#08101f);color:var(--ink);font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial,sans-serif;}
    header{display:flex;align-items:center;gap:12px;padding:14px 18px;border-bottom:1px solid #1e2a44;background:#0b1220;position:sticky;top:0;z-index:10}
    .logo{display:flex;align-items:center;gap:10px;font-weight:800}
    .logo img{width:34px;height:34px;border-radius:7px}
    .wrap{max-width:1200px;margin:0 auto;padding:18px}
    .grid{display:grid;grid-template-columns:1.1fr .9fr;gap:18px}
    @media(max-width:980px){.grid{grid-template-columns:1fr}}
    .card{background:#10192e;border:1px solid #1e2a44;border-radius:18px;padding:16px 16px 12px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
    .btn{display:inline-flex;align-items:center;justify-content:center;padding:10px 14px;border-radius:12px;cursor:pointer;border:1px solid #2a3d66;background:#0e1b38;color:var(--ink)}
    .btn.primary{background:linear-gradient(180deg,#0ea5ff,#0075ff);color:#051027;font-weight:700;border:none}
    .preview{white-space:pre-wrap;background:#0a1226;border:1px dashed #30456f;border-radius:12px;padding:12px;overflow-wrap:anywhere}
    .pill{display:inline-flex;align-items:center;gap:8px;background:#0a1330;border:1px solid #203154;border-radius:999px;padding:6px 10px;font-size:12px}
    .hr{height:1px;background:#1e2a44;margin:12px 0}
  </style>
</head>
<body>
<header>
  <div class="logo">
    <img src="./icons/icon-192.png" alt="DW"/>
    <div>
      <div>Danbury Wheel Chair Service</div>
      <div class="pill" id="rolePill">‚Äî</div>
    </div>
  </div>
  <div style="margin-left:auto;display:flex;gap:10px">
    <button id="btnInstall" class="btn">Install</button>
    <select id="langSel" class="btn">
      <option value="auto">üåê Auto</option><option value="es">ES</option><option value="en">EN</option>
    </select>
    <button id="btnSignOut" class="btn" style="display:none">Sign out</button>
  </div>
</header>

<div class="wrap">
  <!-- Login -->
  <section id="sectionAuth" class="card" style="display:none;text-align:center">
    <img src="./icons/icon-192.png" width="72" height="72"/>
    <h2 id="welcomeTitle"></h2>
    <div id="welcomeSub"></div>
    <input id="email" placeholder="Email" style="display:block;margin:10px auto"/>
    <input id="password" placeholder="Password" type="password" style="display:block;margin:10px auto"/>
    <button id="btnSignIn" class="btn primary"></button>
  </section>

  <!-- Dispatcher UI -->
  <div id="dispatcherUI" style="display:none">
    <section class="card">
      <h2 id="title_form"></h2>
      <label id="lbl_client"></label><input id="clientName"/><br/>
      <label id="lbl_client_phone"></label><input id="clientContact"/><br/>
      <label id="lbl_pick"></label><input id="from"/><br/>
      <label id="lbl_drop"></label><input id="to"/><br/>
      <label id="lbl_passenger"></label><input id="passenger"/><br/>
      <label id="lbl_price"></label><input id="price"/><br/>
      <label id="lbl_driver"></label><select id="driverSel"></select><br/>
      <div class="hr"></div>
      <button id="btnPreview" class="btn">üìÑ</button>
      <button id="btnSendDriver" class="btn primary">üì®</button>
      <div class="hr"></div>
      <div id="preview" class="preview"></div>
    </section>
  </div>

  <!-- Driver UI -->
  <div id="driverUI" style="display:none">
    <section class="card">
      <h2 id="drv_title"></h2>
      <div class="pill" id="drv_done_lbl"></div>
      <div class="pill" id="drv_sched_lbl"></div>
      <div class="hr"></div>
      <div><h3 id="todayLbl"></h3><div id="drv_today" class="preview"></div></div>
      <div><h3 id="upcomingLbl"></h3><div id="drv_upcoming" class="preview"></div></div>
    </section>
  </div>
</div>

<script type="module">
  import { initializeApp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-app.js";
  import { getAuth, signInWithEmailAndPassword, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-auth.js";
  import { getFirestore, collection, addDoc, getDocs, query, where, serverTimestamp } from "https://www.gstatic.com/firebasejs/10.13.1/firebase-firestore.js";

  const firebaseConfig = {
    apiKey: "AIzaSyBIBq4ZsRADoKRNoJZkNq-dLWirlSotIPc",
    authDomain: "tripfast-d359d.firebaseapp.com",
    projectId: "tripfast-d359d",
    storageBucket: "tripfast-d359d.firebasestorage.app",
    messagingSenderId: "559477235356",
    appId: "1:559477235356:web:a311792f680f5fd5995759",
    measurementId: "G-CSRR8VWYFZ"
  };
  const app = initializeApp(firebaseConfig);
  const auth = getAuth(app);
  const db = getFirestore(app);

  const DISPATCHERS = ["donbeltranmusic@gmail.com"];
  const DRIVERS = ["fmluisorlando@gmail.com"];

  const STRINGS = {
    en: {
      welcome:"Welcome", signin:"Sign in to continue",
      new_dispatch:"New dispatch", client:"Client", client_phone:"Client phone/email",
      pick:"Pickup", drop:"Dropoff", passenger:"Passenger", price:"Price (USD)", driver:"Driver",
      generate:"Generate summary", send:"Send to driver",
      my_jobs:"My jobs", trips_done:"Trips done", trips_sched:"Scheduled",
      today:"Today", upcoming:"Upcoming"
    },
    es: {
      welcome:"Bienvenido", signin:"Inicia sesi√≥n para continuar",
      new_dispatch:"Nuevo despacho", client:"Cliente", client_phone:"Tel√©fono/email del cliente",
      pick:"Recoger", drop:"Destino", passenger:"Pasajero", price:"Precio (USD)", driver:"Conductor",
      generate:"Generar resumen", send:"Enviar al conductor",
      my_jobs:"Mis viajes", trips_done:"Viajes realizados", trips_sched:"Programados",
      today:"Hoy", upcoming:"Pr√≥ximos"
    }
  };
  function getLang(){const forced=localStorage.getItem('lang')||'auto';if(forced!=='auto') return forced;return (navigator.language||'en').startsWith('es')?'es':'en';}
  function t(k){return STRINGS[getLang()][k]||k;}
  function applyTexts(){
    document.getElementById("welcomeTitle").textContent=t("welcome");
    document.getElementById("welcomeSub").textContent=t("signin");
    document.getElementById("btnSignIn").textContent=t("welcome");
    document.getElementById("title_form").textContent=t("new_dispatch");
    document.getElementById("lbl_client").textContent=t("client");
    document.getElementById("lbl_client_phone").textContent=t("client_phone");
    document.getElementById("lbl_pick").textContent=t("pick");
    document.getElementById("lbl_drop").textContent=t("drop");
    document.getElementById("lbl_passenger").textContent=t("passenger");
    document.getElementById("lbl_price").textContent=t("price");
    document.getElementById("lbl_driver").textContent=t("driver");
    document.getElementById("btnPreview").textContent="üìÑ "+t("generate");
    document.getElementById("btnSendDriver").textContent="üì® "+t("send");
    document.getElementById("drv_title").textContent=t("my_jobs");
    document.getElementById("drv_done_lbl").textContent=t("trips_done")+": 0";
    document.getElementById("drv_sched_lbl").textContent=t("trips_sched")+": 0";
    document.getElementById("todayLbl").textContent=t("today");
    document.getElementById("upcomingLbl").textContent=t("upcoming");
  }
  applyTexts();
  const sel=document.getElementById("langSel"); sel.value=localStorage.getItem('lang')||'auto';
  sel.addEventListener("change",()=>{localStorage.setItem('lang',sel.value);location.reload();});

  let currentSummary=null;
  document.getElementById("btnPreview").addEventListener("click",()=>{
    const msg=`${t("client")}: ${document.getElementById("clientName").value}\n${t("passenger")}: ${document.getElementById("passenger").value}\n${t("pick")}: ${document.getElementById("from").value}\n${t("drop")}: ${document.getElementById("to").value}\n${t("price")}: ${document.getElementById("price").value}`;
    document.getElementById("preview").textContent=msg; currentSummary=msg;
  });

  document.getElementById("btnSendDriver").addEventListener("click",async()=>{
    if(!currentSummary){alert("Generate summary first");return;}
    const job={
      createdAt:serverTimestamp(),
      clientName:document.getElementById("clientName").value,
      passenger:document.getElementById("passenger").value,
      from:document.getElementById("from").value,
      to:document.getElementById("to").value,
      price:document.getElementById("price").value,
      driverRef:document.getElementById("driverSel").value
    };
    await addDoc(collection(db,"jobs"),job);
    alert("Sent to driver");
  });

  onAuthStateChanged(auth,user=>{
    if(!user){document.getElementById("sectionAuth").style.display="block";return;}
    if(DISPATCHERS.includes(user.email)){document.getElementById("dispatcherUI").style.display="block";}
    if(DRIVERS.includes(user.email)){document.getElementById("driverUI").style.display="block";}
  });
  document.getElementById("btnSignIn").addEventListener("click",async()=>{
    try{await signInWithEmailAndPassword(auth,document.getElementById("email").value,document.getElementById("password").value);}catch(e){alert(e.message);}
  });
  document.getElementById("btnSignOut").addEventListener("click",()=>signOut(auth));
</script>
</body>
</html>
